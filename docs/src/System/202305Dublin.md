# 202305 Dublin
# System WW - 2023/1
 - When: June 12 - 16, 2023
 - Location: Met Eireann, 65/67 Glasnevin Hill, Dublin 9 D09 Y921 Ireland [https://goo.gl/maps/DZDtzcBEgz7g9Bj79](https://goo.gl/maps/DZDtzcBEgz7g9Bj79)
 - Markdown format [Cheatsheet](https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet) 
 - Meet link https://meet.google.com/xwx-hhrq-uuy 
 
![WhatsApp Image 2023-06-14 at 15 45 54](https://github.com/Hirlam/SystemWW/assets/17612201/4d3e0be2-7a67-42bf-825b-6b8144b5a966)

**Official picture**

![944AA9CC-DC3A-42A5-A5FD-79966416A2CA](https://github.com/Hirlam/SystemWW/assets/12233522/68019135-f6b1-44bf-9aed-28a44eb411ad)

**Un-official picture**

## Participants
@dsantosm, @ToonMoene, @romick-knmi, @BertvanUlft, @ovignes, @roelstappers, @joewkr, @ConorDaly-met, @j-fannon
Anyone else?
 
Name               | Institute  | ARR - DEP             |  Hotel    | Notes
---                | ---        | ---                   | ---       | ---
Daniel Santos      | DMI        | Sun - Fri             | Yugo Kavanagh| |
Eoin Whelan        | METIE      | Mon - Fri             | Casa Whelan   | |
Roel Stappers      | MET Norway | Sun - Thu (18:30 DUB) | Skylon Hotel  | |
Conor Daly         | METIE      | Mon - Fri             | Casa Daly   | |
Bert van Ulft      | KNMI       | Sun - Fri             | Skylon Hotel  | |
Toon Moene         | KNMI       | Mon 12:00 - Fri 16:00 | Egans House   | |
Christopher Romick | KNMI       | Sun - Thur            | Skylon Hotel | |
Ole Vignes         | MET Norway | Sun - Fri             | DCU Campus   | |


## Hotels
[A booking.com search for Glasnevin](https://www.booking.com/searchresults.en-gb.html?ss=Glasnevin&ssne=Glasnevin&ssne_untouched=Glasnevin&label=gen173nr-1BCAEoggI46AdIM1gEaGmIAQGYAQm4ARnIAQzYAQHoAQGIAgGoAgO4Ar3hqqIGwAIB0gIkOTdjOTM5MTEtOTBmNi00NDU0LTk4ZWItZDZkNmRiMmYxMTQ12AIF4AIB&sid=fddee014718ff339cddb8fcfaee313c0&aid=304142&lang=en-gb&sb=1&src_elem=sb&src=searchresults&dest_id=-1503028&dest_type=city&checkin=2023-06-11&checkout=2023-06-16&group_adults=1&no_rooms=1&group_children=0&sb_travel_purpose=leisure)

## Refreshments

|   |   |
|---|---|
| Coffee   | 1045    | 
| Lunch    | 1300    | 
| Coffee   | 1500    | 

## On site meeting info
* The WW will be held in the Conference Room
* Report to reception each day. Eoin or another Irish colleague will fetch you


## Tentative agenda
* CY49T1 contribution strategy and working practices
* CY49T1h and Tiger team concepts
* CY46h1 tagging 
* hirlam.org movement to SKG
* SP for EPS status 

## Meeting notes
###  CY49T1h and Tiger team concepts
  - [Slides ](https://docs.google.com/presentation/d/1qtnvzzLBvd-PcOX0i2dqWlvOeCH__qhGKn4J1FLfr_o/edit?usp=sharing)
  - DEODE scripting probably is not using the level of modularity that allows using some stand-alone components by Harmonie scripting such BC treatment. This lack of modularity was generated by the urgency of having deliverables by the project but also prevents an more efficient transfer and collaboration with the current scripting
  - **Roel** showed the Julia stdlib modularity as an example where in every package there is a doc/src, src, test and Project.toml with Project.tom describing the dependencies on other packages 
  - CY49T1h offers more opportunities to promote a more continuous integration workflow
     - We need to be more strict on the norms and test to promote harmonie codes. 
     - cmake establish some control about some dependencies that can help
  - CY49Th1 will be a branch or a fork in HIRLAM GitHub
     - as a branch we will increase the contribution visibility and facilitate the code integration
     - as a fork we have more freedom in HIRLAM GitHub
  - scripts_&_utils repo will be created in HIRLAM GitHub
 
### CY49T1 integration working practices
  - Use the [list of possible contributions (wiki)](https://github.com/Hirlam/SystemWW/wiki/CY49T1-HIRLAM-contributions)
       - Has been updated and crosschecked up to 20230614
       - We are going to group commits per area per topic per feature
       - Create a harmonie issue to monitor the progress.
            - New milestone is defined
  - Follow the general process described in [CONTRIBUTING.md](https://github.com/ACCORD-NWP/IAL/blob/accord_CY49T0_to_T1/.github/CONTRIBUTING.md)
       - Use this code as base at ECMWF: https://github.com/ACCORD-NWP/IAL/tree/accord_CY49T0_bf
       - **Branches nomenclature**: although not anymore strictly mandatory with the use of Github, the legacy nomenclature
  about IAL branches (`<user>_<CYCLE>_<feature>`, e.g. `mary_CY48T1_mysuperdev`)
       - Add HIRLAM hash in the commit message to keep track of the contributions sent.
  - Run Davaï at ECMWF/Belenos:
     - DAVAI status at ECMWF:
       - **UPDATED** [How to:](https://github.com/ACCORD-NWP/DAVAI-env/blob/master/doc/atos_bologna.md)
          - The default billing account is `spfracco`, you can ask **Daniel** to grant you access or use your national account by commenting it out in the file : `conf/davai_nrv.ini`
              - For commenting the `spfracco` billing account 
              ```
               # Davai options 
               # billing_account     = spfracco 
               # billing_account_ft  = spfracco
              ```
          - Test case: DV49T0_to_T1 explained [here](https://github.com/ACCORD-NWP/DAVAI-tests/wiki/Versions-of-tests)
          - When running DAVAI at ECMWF-Atos make sure to have the intel program environment loaded by setting `module load prgenv/intel` or `module load pi` in your `.bash_profile`
          - **Daniel modules**
             ```
              # Start with a clean environment 
                module purge 
              
              # Load the needed modules for davai and Gmkpack  
                module load python3
                module load pi
                module load ecmwf-toolbox/2021.08.3.0
                module use ~rm9/public/modulefiles
                module load davai 
           
                module load intel/2021.4.0

              # Gmkpack is installed at Ryad El Khatib's
                HOMEREK=~rme
                export GMKROOT=$HOMEREK/public/bin/gmkpack
              # use efficiently filesystems
                export ROOTPACK=$PERM/rootpack
                export HOMEPACK=$PERM/pack
                export GMKTMP=$TMPDIR/gmktmp
              # default compilation options
                export GMKFILE=OMPIIFC2104.AA
                export GMK_OPT=x
              # update paths
                export PATH=$GMKROOT/util:$PATH
                export MANPATH=$MANPATH:$GMKROOT/man
             ```
  - Create a pull request in IAL repo:
     - Coordination:
       - EPS **Ole**
           - SPG changes by **Ole**
       - Physics **Bert**
       - DA and Obs **Eoin and Roel**
       - Technical changes **Daniel and Chris**

#### Possible option to use git for forward phasing dev-CY46h1 to accord_CY49T0_bf
Create a fork of ACCORD-NWP/IAL on github, if you haven't done so. Then follow steps below:
```
# Clone IAL user fork
> git clone git@github.com:<git_user_name>/IAL.git
Cloning into 'IAL'...
remote: Enumerating objects: 452182, done.
remote: Counting objects: 100% (10857/10857), done.
remote: Compressing objects: 100% (243/243), done.
remote: Total 452182 (delta 10663), reused 10621 (delta 10608), pack-reused 441325
Receiving objects: 100% (452182/452182), 541.26 MiB | 14.93 MiB/s, done.
Resolving deltas: 100% (366947/366947), done.
Updating files: 100% (18054/18054), done.

# Go into the clone's directory
> cd IAL

# Add the Harmonie repo as remote and fetch it, without the tags
> git remote add Harmonie git@github.com:Hirlam/Harmonie.git
> git fetch Harmonie --no-tags
remote: Enumerating objects: 80436, done.
remote: Counting objects: 100% (9476/9476), done.
remote: Compressing objects: 100% (509/509), done.
remote: Total 80436 (delta 9015), reused 9286 (delta 8956), pack-reused 70960
Receiving objects: 100% (80436/80436), 255.76 MiB | 15.27 MiB/s, done.
Resolving deltas: 100% (61284/61284), completed with 4448 local objects.
From github.com:Hirlam/Harmonie
 * [new branch]            dev-CY46h1             -> Harmonie/dev-CY46h1
 * [new branch]            dev-CY46h1_eps         -> Harmonie/dev-CY46h1_eps
 * [new branch]            dev-CY46h1_spp_surface -> Harmonie/dev-CY46h1_spp_surface
 * [new branch]            harmonEPS-43h2.2       -> Harmonie/harmonEPS-43h2.2
 * [new branch]            harmonie-43h2.2_bf     -> Harmonie/harmonie-43h2.2_bf

# Create a branch to implement your development in same directory ...
> git checkout -b <user>_CY49T0_<description> origin/accord_CY49T0_bf
branch '<user>_CY49T0_<description>' set up to track 'origin/accord_CY49T0_bf'.
Switched to a new branch '<user>_CY49T0_<description>'
# ... or via worktree, cd to it
git worktree add -b <user>_CY49T0_<description> ../<user>_CY49T0_<description> origin/accord_CY49T0_bf
Preparing worktree (new branch '<user>_CY49T0_<description>')
branch '<user>_CY49T0_<description>' set up to track 'origin/accord_CY49T0_bf'.
Updating files: 100% (18054/18054), done.
HEAD is now at 97d45f0a90 Workaround an Intel 2021.4.0 bug : Turn some FIRSTPRIVATE variables into PRIVATE (on behalf P.Marguinaud)
> cd ../<user>_CY49T0_<description>

# Remove upstream (optional)
> git branch --unset-upstream

# Create patch and merge in, using the commit hash, e.g.:
> git format-patch -k --stdout aa99072424~1...aa99072424 -- src  | git am -3 -ks
Applying: add switch for shallow convection in EDMFm (#581)
Using index info to reconstruct a base tree...
A	src/arpifs/module/yomparar.F90
A	src/arpifs/namelist/namparar.nam.h
A	src/arpifs/phys_dmn/suparar.F90
A	src/arpifs/phys_dmn/vdfhghtnhl.F90
/home/ulft/temp/IAL_in_Harmonie/IAL/.git/worktrees/ulft_CY49T0_bla/rebase-apply/patch:65: trailing whitespace.
LSHALLOWMF=.TRUE. 
warning: 1 line adds whitespace errors.
Falling back to patching base and 3-way merge...
Auto-merging arpifs/phys_dmn/vdfhghtnhl.F90
Auto-merging arpifs/phys_dmn/suparar.F90
Auto-merging arpifs/namelist/namparar.nam.h
Auto-merging arpifs/module/yomparar.F90
CONFLICT (content): Merge conflict in arpifs/module/yomparar.F90
error: Failed to merge in the changes.
Patch failed at 0001 add switch for shallow convection in EDMFm (#581)

# If any conflicts, solve them (with e.g. meld), add the resolved files, and continue to finalize
> meld arpifs/module/yomparar.F90
> git add arpifs/module/yomparar.F90
> git am --continue
Applying: add switch for shallow convection in EDMFm (#581)

# Modify commit message with --amend
# Prepend references to PRs & issues with Hirlam/Harmonie
# Add commit message as: Harmonie commmit: Hirlam/Harmonie@aa990724240a50faf6659777596cda60a9e93137
> git commit --amend
[<user>_CY49T0_<description> 86c5bf2224] add switch for shallow convection in EDMFm (Hirlam/Harmonie#581)
 Author: Natalie Theeuwes <19662980+natalieth@users.noreply.github.com>
 Date: Fri Jan 20 08:46:10 2023 +0100
 4 files changed, 10 insertions(+), 3 deletions(-)

# Push to user fork
git push -u origin <user>_CY49T0_<description>

# Then run Davai & create PR
```
        
### Harmonie-46h1 tagging 
 - [Validation strategy](https://github.com/Hirlam/Harmonie/wiki/Validation-for-tagging-Harmonie-46h1)
 - [New branch for release candidate management](https://github.com/Hirlam/Harmonie/tree/CY46h1_release_candidates)
    - New milestone to change the settings before tagging rc1 https://github.com/Hirlam/Harmonie/milestone/5
    - Pull requests checked before the branching:
       - FIXES for SPG( i.e. running parts in DP ):
          - The changes are not clean enough and we can promote in a phasing exercise. Removed from https://github.com/Hirlam/Harmonie/pull/787
          - As we plan to create the CY49T1h in ACCORD forge could facilitate a cleaner implementation of SPG **Ole**
       - FAKETREES
          - Set to TRUE to maintain the consistency
       - Parallel MPI and PREP implementation based on the DEODE commits to speed up large domains like in CARRA2 **Patrick & Ulf**
          - [See his merged PR here in the Deode branch](https://github.com/DEODE-NWP/IAL/commit/28648fcef7829cc864f5a5384376c6e59ff1accb).
          - Some problems still in PREP reported by **Ulf**
          - **Yurii** is checking 
          - **Can be introduce after the rc1 declaration as tech change**
       - gl for MUSC **Conor**
          - Extend the testbed to gl 

### Testbed 
 - How to use as a proactive mode?
     - In hlam is run automatically after the commit is pushed.
     - Create a fix referene (REFEXP) for each cycle in hlam
     - Update it ... how???

### Hirlam.org movement to SKG
 - List of services:

```
root@hirlam:~# systemctl --type=service --state=running
UNIT                     LOAD   ACTIVE SUB     DESCRIPTION
accounts-daemon.service  loaded active running Accounts Service
apache2.service          loaded active running LSB: Apache2 web server
avahi-daemon.service     loaded active running Avahi mDNS/DNS-SD Stack
cron.service             loaded active running Regular background program processing daemon
cups-browsed.service     loaded active running Make remote CUPS printers available locally
cups.service             loaded active running CUPS Scheduler
dbus.service             loaded active running D-Bus System Message Bus
exim4.service            loaded active running LSB: exim Mail Transport Agent
[getty@tty1.service](mailto:getty@tty1.service)       loaded active running Getty on tty1
ibmspdzm.service         loaded active running IBM SP (TSM) service in DMZ mode
irqbalance.service       loaded active running LSB: daemon to balance interrupts for SMP systems
munin-node.service       loaded active running Munin Node
mysql.service            loaded active running MySQL Community Server
networker.service        loaded active running LSB: EMC Networker. A backup and restoration software package.
ntp.service              loaded active running LSB: Start NTP daemon
polkitd.service          loaded active running Authenticate and Authorize Users to Run Privileged Tasks
rsyslog.service          loaded active running System Logging Service
runit.service            loaded active running Runit service supervision
shiny-server.service     loaded active running ShinyServer
ssh.service              loaded active running OpenBSD Secure Shell server
systemd-journald.service loaded active running Journal Service
systemd-logind.service   loaded active running Login Service
systemd-udevd.service    loaded active running udev Kernel Device Manager
[user@0.service](mailto:user@0.service)           loaded active running User Manager for UID 0
[user@1009.service](mailto:user@1009.service)        loaded active running User Manager for UID 1009
[user@1016.service](mailto:user@1016.service)        loaded active running User Manager for UID 1016
[user@999.service](mailto:user@999.service)         loaded active running User Manager for UID 999

Note that e.g. git and svn are not listed, as they are not "services" in the linux sense.
Btw., I just stopped mailman, it would otherwise be in the list.
```

 - Reduce the data stored on Data Portal:
    - **Xiaohua** Contacted as main responsible
    - The rest of the responsible names will be contacted also **Done*
```
/data/portal# ls -alt
total 1124
drwxr-xr-x   4 cooper    www-data   4096 Jun 15 11:16 metcoop
drwxrwxr-x   2 faov      www-data   4096 Jun 15 11:07 phasing
drwxr-xr-x   2 faov      www-data   4096 Jun 15 11:06 osisaf
drwxrwsrwx  18 markku    www-data 987136 Jun 15 09:14 mastdata
drwxrwsrwx  33 xiaohua   www-data  12288 Jun  5 20:33 dmi
drwxrwxr-x  44 operaemet www-data   4096 May 31 12:55 aemet
drwxrwxr-x  22 xiaohua   www-data   4096 May 27 11:51 validation
drwxr-xr-x  90 xiaohua   www-data   4096 May  2 21:02 OprVer
drwxrwxrwx  14 ulf       admin      4096 Mar 17 10:25 harp
drwsrwsrwx  27 ulf       wwwsmhi    4096 Jan 25 07:40 smhi
-rwxr-xr-x   1 cperalta  wwwdmi     3984 Sep 26  2022 dmi_local_verification
drwxrwxrwx  31 root      www-data   4096 Sep 26  2022 .
drwxrwsr-x   7 metno     www-data   4096 Sep 20  2022 metno
drwxrwxrwx   6 cperalta  wwwdmi     4096 Aug 19  2022 uwc_west
drwxrwx---   7 xiaohua   www-data   4096 Apr  7  2022 oprint
drwxrwxrwx   9 ahally    www-data   4096 Dec 14  2021 metie
drwxr-xr-x  30 egleeson  wwwmetie   4096 Dec 14  2021 egleeson
drwxrwxrwx  96 ulf       wwwsmhi    4096 Aug 24  2021 harmonEPS
drwxr-xr-x   3 wverkleij wwwknmi    4096 Jul 30  2021 knmi
drwxrwxr-x  21 kpn       www-data   4096 Dec 25  2020 kpn
-rw-r--r--   1 root      root        316 Dec 14  2020 du-hcs_20201214.out
drwxrwxr-x  19 xiaohua   www-data   4096 Jul 31  2020 download
drwxr-xr-x   5 xiaohua   www-data   4096 May 27  2020 CARRA
drwxr-xr-x   7 root      root       4096 Aug  6  2019 ..
drwxr-xr-x  21 siggi     siggi      4096 Jul  2  2019 imo
drwxr-xr-x   3 aarne     www-data   4096 Aug 25  2018 emhi
drwxr-xr-x   2 martynas  www-data   4096 Aug 25  2018 lhms
drwxr-xr-x   6 xiaohua   www-data   4096 Mar  1  2018 glameps
drwxr-xr-x   6 ksa       www-data   4096 Nov 26  2017 GLAMEPS
drwxrwsr-x   5 www-data  www-data   4096 Dec 21  2015 fmi
drwxr--r-- 419 xiaohua   www-data  24576 Nov 17  2011 MGM
drwxr-xr-x   3 ulf       www-data   4096 Sep 26  2011 doxygen_browser
drwxr-xr-x   7 www-data  www-data   4096 Apr  4  2007 model-inter
```


 - After the movement to SKG:
    - Stop gitolite and svn:
      - Contact people that have forks to be sure that can be removed
      - Wiki only read access and make backup copy 

## Topics 
* Can we improve workflow practices on Github and use new features of Team plan 
  * CODEOWNERS, protect branches, draft PRS, .... 
* Discussion on configuration handling in Harmonie https://github.com/Hirlam/Harmonie/pull/837
* Improve source code organization (also for DEODE-prototype and AccordDATools)
<details>
<summary>Testbed (First needs https://github.com/Hirlam/Harmonie/pull/837)</summary>
- Implemented github action to run testbed in the cloud and at ECMWF 
- Instead of https://github.com/Hirlam/HarmonieTestbed-composite-action implement RunExperiment-composite-action taking 
  
```yaml
  inputs:
      config:            
          description: configuration to run 
          default:  AROME_3DVAR
          required: true 
      host: 
         default: config.github 
         required: true
      dtg:
         required: true 
      dtgend: 
         required: true  
          
```
- Treat testbed config as normal harmonie_config. In the cloud start all testbed experiment in parallel with `Harmonie setup -c inputs.config`. I.e. don't uses the "Master testbed exp" that creates currently creates the childs in ecflow 
- Add config.github for $SCRATCH etc  .  
- Add Artifacts for climate files 
- Install ecflow in cloud 
- Skip testbed runs for climate generation? 
- Testbed_comp as separate github action. 
- Log files will be available from the github action. Posting using github api to discusions no longer necessary. 
- Run gitub action as a branch protection on dev-CY46h1. I.e. testbed only runs just before the merge of a PR. Disable any direct commits 
to dev-CY46h1
- To discuss: Do we want to maintain a system like this? The alternative is to have a self host runner at ECMWF and would be a lot easier to maintain: just a github actions that does `mkdir hm_home/exp`, `git clone` `Harmonie setup `, `Harmonie testbed`
</details>

- plans for CY48/CY49/CY50 Harmonie versions
- GPU refactoring requirements: Harmonie config in DAVAI, CY49 compilation, ecBundle
- Location for non-system documentation (e.g. evaluation results with lots of images)



